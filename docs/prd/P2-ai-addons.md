# PRD: P2 - AI Add-ons (Billing & Gating)

## 1. Overview
This document defines the technical and operational framework for "Practical AI" features. All AI features are **Optional Paid Add-ons**, disabled by default, and metered for cost control.

## 2. Gating & Enablement Model
- **Default State**: Every tenant (`tenant_config`) has `enable_ai: false` by default.
- **Entitlement**: AI features are only visible/accessible once a school purchases the `ai_addon_v1` entitlement.
- **Admin Opt-In**: Even after purchase, a Tenant Admin must explicitly toggle individual AI modules (e.g., `enable_parent_helpdesk: true`) in the "Control Center".

## 3. Features (v1)

### A1) Teacher Copilot (Drafting Assist)
- **Workflow**: Teacher-in-the-loop. Generates drafts for lesson plans, worksheets, and quizzes.
- **Constraint**: Final content must be reviewed and "Published" by the teacher.
- **Billing**: Metered per generation job.

### A2) Parent Helpdesk (RAG)
- **Workflow**: 24/7 WhatsApp/Web chat grounded in tenant ERP records.
- **Constraint**: Responses must cite source Record IDs. No hallucinated data.
- **Billing**: Metered per conversation (billed via `wallet_balance`).

### A3) Fee Intelligence (Explainable)
- **Workflow**: Predictive flags on student records for late payment risk.
- **Constraint**: Reasoning must be visible to Accountant (e.g., "3 late payments in 6 months").
- **Billing**: Monthly recurring add-on fee.

### A4) Voice Notes
- **Workflow**: Voice-to-text for staff remarks.
- **Billing**: Per minute of processed audio.

## 4. Cost Controls & Metering
### 4.1 Metering Dimensions
- **Completion Tokens**: Raw tokens generated by LLM provider.
- **Conversation Count**: WhatsApp-initiated session threads.
- **Transcription Minutes**: For A4 Voice Notes.

### 4.2 Budget & Quotas
- **Monthly Budget Cap**: Admin can set a hard limit (e.g., â‚¹5,000/mo) for AI usage.
- **Rate Limiting**: Per-user limits (e.g., 50 queries/hour) to prevent runaway costs.
- **Kill Switch**: 
  - **Global**: SaaS Admin can disable all AI API routes project-wide.
  - **Tenant**: School Admin can disable AI immediately if budget is anomalous.

### 4.3 Fallback Behavior
- If budget is exhausted or `enable_ai` is false:
  - **Teacher UI**: "AI drafting unavailable. Upgrade plan." button.
  - **Parent Chat**: AI remains silent; query falls back to standard "Triage to Human" notice.

## 5. Security & Safety
- **Data Grounding**: Retrieval-Augmented Generation (RAG) ensures answers only come from uploaded circulars/notices.
- **Redaction**: PII (Phone/Address) is masked before sending to model providers.
- **Audit Logs**: Every prompt/completion pair is logged with the original `user_id` and `tenant_id`.

## 6. QA Plan
- **Billing Integrity**: Verify that queries fail correctly when `wallet_balance` is zero.
- **Adversarial**: Test for prompt injection (e.g., trying to trick the bot into revealing other tenants' data).
- **Latency**: Ensure LLM timeouts do not hang core API responses (must be async/worker-driven).
